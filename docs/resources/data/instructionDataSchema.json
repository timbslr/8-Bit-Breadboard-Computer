{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$defs": {
    "microOperation": {
      "type": "string",
      "enum": [
        "OE_<reg>",
        "OE_<regs>",
        "OE_<regss>",
        "IE_<reg>",
        "IE_<regd>",
        "IE_<regsd>",
        "IE_MAR_L",
        "IE_MAR_H",
        "IE_PC_L",
        "OE_PC_L",
        "IE_PC_H",
        "OE_PC_H",
        "INC_PC",
        "IE_SP_H",
        "OE_SP_H",
        "IE_SP_L",
        "OE_SP_L",
        "RSC",
        "IE_A",
        "OE_A",
        "IE_TMP",
        "OE_TMP",
        "IE_B",
        "OE_B",
        "IE_X",
        "OE_X",
        "INC_X",
        "DEC_X",
        "IE_Y",
        "OE_Y",
        "INC_Y",
        "DEC_Y",
        "OE_SER_RX",
        "IE_F",
        "OE_F",
        "OE_ALU",
        "IE_BUF",
        "OE_BUF",
        "IE_IR",
        "OE_IR",
        "IE_7SD",
        "7SD_SM",
        "7SD_UM",
        "LCD_<lcdreg>",
        "LCD_E",
        "LCD_READ",
        "LCD_WRITE",
        "SER_RX_CONS",
        "SER_RX_SEND",
        "MEM_WE",
        "ALU_BOP_AND",
        "ALU_BOP_OR",
        "ALU_BOP_XOR",
        "ALU_BOP_NOT",
        "ALU_BOP_SLR",
        "ALU_BOP_SAR",
        "ALU_BOP_ROR",
        "ALU_BOP_ROL",
        "ALU_SRC_ARI",
        "ALU_SRC_BIT",
        "ALU_CIN",
        "ALU_AOP_ADD",
        "ALU_AOP_SUB",
        "MEM_EN_IO",
        "HALT"
      ]
    },
    "register": {
      "type": "string",
      "enum": [
        "PC_L",
        "PC_H",
        "MAR_L",
        "MAR_H",
        "IR",
        "BUF",
        "SP_L",
        "SP_H",
        "A",
        "F",
        "TMP",
        "B",
        "X",
        "7SD"
      ]
    }
  },

  "type": "object",
  "properties": {
    "$schema": { "type": "string" },
    "instructions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "minLength": 3
          },
          "mnemonic": {
            "type": "string",
            "minLength": 2
          },
          "type": {
            "type": "string",
            "enum": ["REAL", "PSEUDO"]
          },
          "operands": {
            "type": "array",
            "items": {
              "type": "string",
              "enum": [
                "reg",
                "lcdreg",
                "imm",
                "addr",
                "n",
                "regd",
                "regs",
                "regsd",
                "regss"
              ]
            }
          },
          "requiresFlag": {
            "type": "boolean"
          },
          "opcode": {
            "type": "string",
            "minLength": 8,
            "maxLength": 8,
            "pattern": "^(0|1|R|L){8}$"
          },
          "microinstructions": {},
          "mappedInstructions": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 4
            },
            "minItems": 1
          },
          "group": {
            "type": "string",
            "enum": [
              "ALU",
              "REG-MEM",
              "I-O",
              "SYS",
              "BR-JMP"
            ]
          },
          "indexInGroup": {
            "type": "number"
          },
          "shortDescription": {
            "type": "string",
            "minLength": 5
          },
          "longDescription": {
            "type": "string",
            "minLength": 20
          },
          "examples": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "prerequisites": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "register": {
                        "$ref": "#/$defs/register"
                      },
                      "value": {
                        "type": "number"
                      }
                    },
                    "required": ["register", "value"],
                    "additionalProperties": false
                  }
                },
                "code": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "minLength": 2
                  },
                  "minItems": 1
                },
                "result": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "register": {
                        "$ref": "#/$defs/register"
                      },
                      "value": {
                        "type": "number"
                      }
                    },
                    "required": ["register", "value"],
                    "additionalProperties": false
                  },
                  "minItems": 1
                }
              },
              "required": [
                "prerequisites",
                "code",
                "result"
              ],
              "additionalProperties": false
            },
            "minItems": 1
          }
        },
        "required": [
          "name",
          "mnemonic",
          "type",
          "operands",
          "group",
          "indexInGroup",
          "shortDescription",
          "longDescription",
          "examples"
        ],
        "additionalProperties": false,
        "allOf": [
          {
            "if": {
              "properties": {
                "type": {
                  "const": "REAL"
                }
              }
            },
            "then": {
              "required": [
                "requiresFlag",
                "opcode",
                "microinstructions"
              ],
              "not": {
                "required": ["mappedInstructions"]
              }
            }
          },
          {
            "if": {
              "properties": {
                "type": {
                  "const": "PSEUDO"
                }
              }
            },
            "then": {
              "not": {
                "required": [
                  "requiresFlag",
                  "opcode",
                  "microinstructions"
                ]
              },
              "required": ["mappedInstructions"]
            }
          },
          {
            "if": {
              "properties": {
                "requiresFlag": {
                  "const": false
                }
              }
            },
            "then": {
              "properties": {
                "microinstructions": {
                  "type": "array",
                  "items": {
                    "type": "array",
                    "items": {
                      "$ref": "#/$defs/microOperation"
                    }
                  },
                  "maxItems": 16
                }
              }
            }
          },
          {
            "if": {
              "properties": {
                "requiresFlag": {
                  "const": true
                }
              }
            },
            "then": {
              "properties": {
                "microinstructions": {
                  "type": "object",
                  "properties": {
                    "0": {
                      "type": "array",
                      "items": {
                        "type": "array",
                        "items": {
                          "$ref": "#/$defs/microOperation"
                        }
                      },
                      "maxItems": 16
                    },
                    "1": {
                      "type": "array",
                      "items": {
                        "type": "array",
                        "items": {
                          "$ref": "#/$defs/microOperation"
                        }
                      },
                      "maxItems": 16
                    }
                  },
                  "required": ["0", "1"],
                  "additionalProperties": false
                }
              }
            }
          }
        ]
      }
    }
  },
  "required": ["$schema", "instructions"],
  "additionalProperties": false
}
